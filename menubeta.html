<!DOCTYPE html>
<html>
<meta charset="utf-8">
<title></title>

<link rel="stylesheet" href="menubeta.css">

<script>
	var language = 0;
	var nbmenus = 0;

	//returns formatted HTML of only one bloc
	function processBloc(bloc, header)
	{
		var res = "";
		var lines = bloc.split('\n');
		var words = "";
		var word = "";

		var i;
		var j;

		for (i = 0; i < lines.length; i++)
		{
			words = lines[i].split('\t');
			for (j = 0; j < words.length; j+=2)
			{
				word = words[j];
				if (word)
				{
					//select the translation (if any) which is right after current word
					if (language==1 && words[j + 1])
						word = words[j + 1];

					//select word style according to title
					//title is deduced from header string
					//unknown title will get default style
					switch (header[j])
					{
						case "menu":
							res += "<p1>" + word + "</p1>";
							break;
						case "categorie":
							res += "<p2>" + word + "</p2>";
							break;
						case "nom":
							res += "<conteneurMenuPrix>"; //A name MUST be followed by a price
							res += "<p4></p4>";
							res += "<p3>" + word + "</p3>";
							break;
						case "prix":
							res += "<p4>" + parseFloat(word) +"â‚¬" + "</p4>";
							res += "</conteneurMenuPrix>"; //A name MUST be followed by a price
							break;
						case "description":
							res += "<p5>" + word + "</p5>";
							break;
						case "commentaire":
							res += "<p6>" + word + "</p6>";
							break;
						default:
							res += "<p>" + word + "</p>";
					}
				}
			}
		}
		return (res);
	}

	//shows the print menu
	//one onclick button per menu
	function showPrintMenus(n)
	{
		var res = "";

		var i;
		res += "<conteneur6>";
		res += "<p7>Print menu </p7>";
		for (i = 0; i < n; i++)
		{
			res += "<p7 onclick=\"printDiv('conteneurMenu', " + i + ")\"> " + i + "</p7>";
		}
		res += "</conteneur6>";
		return res;
	}

	//parses table and returns formatted HTML
	function processTable(input)
	{
		var res = "";
		var header = input.split('\n')[0].split('\t'); //header is the first row
		var corpus = input.split('\n').slice(1).join('\n'); //corpus is the rest
		var blocs = corpus.split(/\n(?=[^\t])/); //each new row starting with (not a tab) is the begining of a new bloc
		var intro = blocs[0]; //first bloc is the intro
		var menus = blocs.slice(1); //other blocs are menus
		
		nbmenus = menus.length;
		res += processBloc(intro, header);
		var i;
		for (i = 0; i < nbmenus; i++)
		{
			console.log(i);
			res += "<conteneurMenu>" + processBloc(menus[i], header) + "</conteneurMenu>";
		}

		console.log(res);
		return res;
	}

	//fetches the table from server
	function fetchFunction()
	{
		
		fetch('menu.tsv')
		.then(response => response.text())
		.then(data =>
		{
			document.getElementById('content').innerHTML=showPage(data);
		});
	}

	//creates a new window with only the content of a dif to allow user to print it
	function printDiv(tagName, page) //print a div
	{
		var divContents = document.getElementsByTagName(tagName)[page].innerHTML;
		var a = window.open('', '', 'height=500, width=500');
		a.document.write('<link rel="stylesheet" href="menubeta.css">');
		a.document.write('<html><body>');
		a.document.write(divContents);
		a.document.write('</body></html>');

		setTimeout(function() //Degueulasse, please find a better way to wait until page loaded before print
		{
			a.print();
		}, 1000);
		
	}

	//returns formated table as HTML and also some other stuff
	function showPage(data)
	{
		var res = "";

		res += processTable(data);
		res += showPrintMenus(nbmenus);
		return (res);
	}
</script>

<body>
<conteneur3>
	<conteneur2>
		<img src="https://simon-ameye.github.io/brume-menu/fr.svg" width="60" height=auto onclick="language=0;fetchFunction()"></img>
		<p7 onclick="language=0;fetchFunction()">FR</p7>
	</conteneur2>
	<conteneur2>
		<img src="https://simon-ameye.github.io/brume-menu/en.svg" width="60" height=auto onclick="language=1;fetchFunction()"></img>
		<p7 onclick="language=1;fetchFunction()">EN</p7>
	</conteneur2>
</conteneur3>

<div id="content"></div>
<script>fetchFunction();</script>

</body>















</html>
